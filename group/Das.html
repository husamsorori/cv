<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة ألمكاتب</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root { --primary-color:#007bff; --secondary-color:#0056b3; }
body { direction: rtl; font-family: Arial, sans-serif; background-color: #f5f7fb; }

.card { transition: all 0.3s; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
.card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); cursor:pointer; }
.img-radius { border-radius: 50%; }
.wid-40 { width:40px; height:40px; }
.members-count, .tasks-count { display:flex; align-items:center; font-size:0.85rem; color:#6c757d; }
.members-count i, .tasks-count i { margin-left:5px; }

.chat-container, .members-container, .tasks-dashboard-container, .member-details-container { 
    display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:1050; flex-direction:column; 
}
.chat-header, .members-header, .tasks-dashboard-header, .member-details-header { 
    padding:1rem; background:var(--primary-color); color:white; display:flex; justify-content:space-between; align-items:center; 
}
.chat-messages, .members-list, .tasks-dashboard-content, .member-details-content { 
    flex:1; padding:1rem; overflow-y:auto; background:#f8f9fa; 
}
.message { margin-bottom:1rem; display:flex; align-items:flex-start; }
.message.sent { justify-content:flex-end; }
.message-content { max-width:70%; padding:0.75rem 1rem; border-radius:18px; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.message.sent .message-content { background:var(--primary-color); color:white; }
.chat-input { padding:1rem; border-top:1px solid #dee2e6; display:flex; }
.chat-input input { flex:1; border-radius:20px; padding:0.5rem 1rem; border:1px solid #ced4da; }
.chat-input button { margin-right:10px; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }

.modal-content { border-radius:12px; border:none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-header { border-bottom:1px solid rgba(0,0,0,0.05); padding:1rem 1.5rem; background-color: #f8f9fa; }
.modal-body { padding:1.5rem; }
.back-btn, .close-btn { background:none; border:none; color:white; display:flex; align-items:center; }

/* تنسيقات جديدة لنظام المهام */
.task-card { border-left: 4px solid; margin-bottom: 10px; }
.task-new { border-left-color: #17a2b8; }
.task-inprogress { border-left-color: #ffc107; }
.task-completed { border-left-color: #28a745; }
.task-delayed { border-left-color: #dc3545; }
.progress { height: 8px; }
.task-status-badge { font-size: 0.7rem; }
.performance-chart-container { height: 200px; }
.member-performance-card { transition: all 0.3s; }
.member-performance-card:hover { transform: scale(1.02); }

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}
.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #dee2e6;
}

/* تنسيقات جديدة لتاريخ المهام */
.days-remaining {
    font-size: 0.75rem;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 10px;
}
.days-normal { background-color: #e9ecef; color: #495057; }
.days-warning { background-color: #fff3cd; color: #856404; }
.days-danger { background-color: #f8d7da; color: #721c24; }
.days-success { background-color: #d1edff; color: #0c5460; }
</style>
</head>
<body>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">إدارة المكاتب</h2>
        <button class="btn btn-primary px-4" onclick="openAddGroupModal()">
            <i class="fas fa-plus me-2"></i>إنشاء مكتب جديد
        </button>
    </div>
    
    <div class="row" id="groupsContainer">
        <!-- سيتم ملؤها بالكود -->
    </div>
</div>

<!-- نافذة الدردشة -->
<div class="chat-container" id="chatContainer">
    <div class="chat-header">
        <button class="back-btn" onclick="closeChat()"><i class="material-icons">رجوع</i></button>
        <h5 class="mb-0" id="chatTitle">دردشة المكتب</h5>
        <div></div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
        <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا...">
        <button class="btn btn-primary" onclick="sendMessage()"><i class="material-icons">send</i></button>
    </div>
</div>

<!-- نافذة الأعضاء -->
<div class="members-container" id="membersContainer">
    <div class="members-header">
        <button class="back-btn" onclick="closeMembers()"><i class="material-icons">رجوع</i></button>
        <h5 class="mb-0" id="membersTitle">أعضاء المكتب</h5>
        <div></div>
    </div>
    <div class="members-list" id="membersList"></div>
</div>

<!-- لوحة متابعة المهام -->
<div class="tasks-dashboard-container" id="tasksDashboardContainer">
    <div class="tasks-dashboard-header">
        <button class="back-btn" onclick="closeTasksDashboard()"><i class="material-icons">رجوع</i></button>
        <h5 class="mb-0" id="tasksDashboardTitle">لوحة متابعة المهام</h5>
        <div>
            <button class="btn btn-light btn-sm me-2" onclick="exportTasksReport('pdf')">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button class="btn btn-light btn-sm" onclick="exportTasksReport('excel')">
                <i class="fas fa-file-excel"></i> Excel
            </button>
        </div>
    </div>
    <div class="tasks-dashboard-content">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3 id="totalTasksCount">0</h3>
                        <p class="mb-0">إجمالي المهام</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3 id="completedTasksCount">0</h3>
                        <p class="mb-0">مهام مكتملة</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3 id="inProgressTasksCount">0</h3>
                        <p class="mb-0">قيد التنفيذ</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h3 id="delayedTasksCount">0</h3>
                        <p class="mb-0">مهام متأخرة</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">مهام الأعضاء</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="filterTasks('all')">الكل</button>
                            <button class="btn btn-sm btn-outline-success" onclick="filterTasks('completed')">المكتملة</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="filterTasks('inprogress')">قيد التنفيذ</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="filterTasks('delayed')">المتأخرة</button>
                        </div>
                    </div>
                    <div class="card-body" id="tasksListContainer">
                        <!-- سيتم ملؤها بالكود -->
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">أداء الأعضاء</h5>
                    </div>
                    <div class="card-body">
                        <div id="membersPerformanceContainer">
                            <!-- سيتم ملؤها بالكود -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة إنشاء مكتب -->
<div class="modal fade" id="addGroupModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">إنشاء مكتب جديد</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-warning mb-3" role="alert" style="font-size: 0.9rem;">
          <i class="fas fa-exclamation-triangle me-2"></i> يُرجى إدخال البيانات تمامًا كما هي في <strong>السجل التجاري</strong>، حيث سيتم مطابقة المعلومات قبل إنشاء المكتب.
        </div>
      
        <form id="addGroupForm">
          <!-- الحقول الأساسية -->
          <div class="mb-3">
            <label for="groupName" class="form-label">الاسم التجاري</label>
            <input type="text" id="groupName" class="form-control" placeholder="أدخل الاسم التجاري" required>
          </div>
          
          <div class="mb-3">
            <label for="groupDescription" class="form-label">الوصف</label>
            <textarea id="groupDescription" class="form-control" placeholder="أدخل وصف المكتب" rows="3" required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="groupField" class="form-label">المجال</label>
            <input type="text" id="groupField" class="form-control" placeholder="أدخل مجال العمل" required>
          </div>

          <!-- اختيار الصفة -->
          <div class="mb-3">
            <label for="groupRole" class="form-label">الصفة</label>
            <select id="groupRole" class="form-select" onchange="toggleOwnerFields()">
              <option value="">-- اختر الصفة --</option>
              <option value="المالك">المالك</option>
              <option value="مدير مكتب المالك">مدير مكتب المالك</option>
            </select>
          </div>

          <!-- حقول المالك -->
          <div id="ownerFields" style="display:none;">
            <div class="mb-3">
              <label for="ownerFullName" class="form-label">الاسم الكامل</label>
              <input type="text" id="ownerFullName" class="form-control" placeholder="أدخل الاسم الكامل">
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">صورة الهوية (الوجه الأمامي)</label>
              <input type="file" id="ownerIDFront" class="form-control" accept="image/*">
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">صورة الهوية (الوجه الخلفي)</label>
              <input type="file" id="ownerIDBack" class="form-control" accept="image/*">
            </div>
            
            <div class="mb-3">
              <label for="ownerPhone" class="form-label">رقم الجوال</label>
              <input type="text" id="ownerPhone" class="form-control" placeholder="أدخل رقم الجوال">
            </div>
          </div>

          <!-- حقول مدير مكتب المالك -->
          <div id="managerFields" style="display:none;">
            <div class="mb-3">
              <label for="ownerName" class="form-label">اسم المالك</label>
              <input type="text" id="ownerName" class="form-control" placeholder="أدخل اسم المالك">
            </div>
            
            <div class="mb-3">
              <label for="managerName" class="form-label">اسم المدير</label>
              <input type="text" id="managerName" class="form-control" placeholder="أدخل اسم المدير">
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">صورة هوية المدير</label>
              <input type="file" id="managerIDImage" class="form-control" accept="image/*">
            </div>
            
            <div class="mb-3">
              <label for="managerPhone" class="form-label">جوال المدير</label>
              <input type="text" id="managerPhone" class="form-control" placeholder="أدخل جوال المدير">
            </div>
            
            <div class="mb-3">
              <label for="ownerPhoneForManager" class="form-label">جوال المالك</label>
              <input type="text" id="ownerPhoneForManager" class="form-control" placeholder="أدخل جوال المالك">
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button class="btn btn-primary" onclick="addGroup()">إنشاء المكتب</button>
      </div>
    </div>
  </div>
</div>

<!-- نافذة إضافة عضو -->
<div class="modal fade" id="addMemberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">إضافة عضو جديد</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="searchSection">
          <div class="mb-3">
            <label for="searchMember" class="form-label">البحث عن عضو</label>
            <input type="text" id="searchMember" class="form-control" placeholder="ابحث عن عضو...">
          </div>
          <div id="searchResult" class="mt-2"></div>
        </div>
        <div id="addSection" style="display:none;">
          <form id="addMemberForm" class="mt-3">
            <div class="mb-3">
              <label for="memberName" class="form-label">اسم العضو</label>
              <input type="text" id="memberName" class="form-control" placeholder="أدخل اسم العضو" required>
            </div>
            
            <div class="mb-3">
              <label for="memberEmail" class="form-label">البريد الإلكتروني</label>
              <input type="email" id="memberEmail" class="form-control" placeholder="أدخل البريد الإلكتروني" required>
            </div>
            
            <div class="mb-3">
              <label for="memberRole" class="form-label">الدور</label>
              <select id="memberRole" class="form-select">
                <option value="member">عضو</option>
                <option value="admin">مدير</option>
                <option value="moderator">مشرف</option>
              </select>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button class="btn btn-primary" id="addMemberBtn" style="display:none;" onclick="addMember()">إضافة العضو</button>
      </div>
    </div>
  </div>
</div>

<!-- نافذة إضافة مهمة -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">إضافة مهمة</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addTaskForm">
          <div class="mb-3">
            <label for="taskTitle" class="form-label">عنوان المهمة</label>
            <input type="text" id="taskTitle" class="form-control" placeholder="أدخل عنوان المهمة" required>
          </div>
          
          <div class="mb-3">
            <label for="taskDescription" class="form-label">الوصف</label>
            <textarea id="taskDescription" class="form-control" placeholder="أدخل وصف المهمة" rows="3" required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="taskPriority" class="form-label">الأولوية</label>
            <select id="taskPriority" class="form-select">
              <option value="عادي">عادي</option>
              <option value="متوسط">متوسط</option>
              <option value="مستعجل">مستعجل</option>
            </select>
          </div>
          
          <!-- حقل تاريخ الاستحقاق -->
          <div class="mb-3">
            <label for="taskDueDate" class="form-label">تاريخ الاستحقاق</label>
            <input type="date" id="taskDueDate" class="form-control" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button class="btn btn-primary" onclick="addTask()">إضافة المهمة</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// البيانات الأساسية
let groups = JSON.parse(localStorage.getItem('officeGroups')) || [];
let selectedGroup = null;
let selectedMemberId = null;
let selectedMemberDetailsId = null;

// --- البيانات الأولية ---
function initializeSampleData() {
  if (groups.length === 0) {
    groups = [
      {
        id: 1,
        name: "صناع الذكاء الرقمي",
        description: "مكتب متخصص في تطوير حلول الذكاء الاصطناعي والتطبيقات البرمجية المتقدمة",
        field: "برمجي",
        created: "2023-10-01",
        members: [
          {
            id: 1,
            name: "أحمد محمد",
            email: "ahmed@digitalmakers.com",
            role: "admin",
            avatar: "https://i.pravatar.cc/150?img=1",
            tasks: [
              {
                title: "تطوير واجهة المستخدم الرئيسية",
                description: "تصميم وتطوير الواجهة الرئيسية للتطبيق باستخدام React.js",
                priority: "مستعجل",
                status: "قيد التنفيذ",
                progress: 75,
                creationDate: "2023-10-10",
                dueDate: getFutureDate(7) // بعد 7 أيام من اليوم
              },
              {
                title: "تحسين تجربة المستخدم للشاشات الصغيرة",
                description: "تعديل التصميم ليكون متجاوباً مع جميع أحجام الشاشات",
                priority: "متوسط",
                status: "جديدة",
                progress: 0,
                creationDate: "2025-11-20",
                dueDate: getFutureDate(14) // بعد 14 يوم من اليوم
              }
            ]
          },
          {
            id: 2,
            name: "سارة عبدالله",
            email: "sara@digitalmakers.com",
            role: "member",
            avatar: "https://i.pravatar.cc/150?img=5",
            tasks: [
              {
                title: "تطوير واجهات برمجة التطبيقات (API)",
                description: "بناء واجهات برمجة التطبيقات للخدمات الخلفية باستخدام Node.js",
                priority: "مستعجل",
                status: "قيد التنفيذ",
                progress: 60,
                creationDate: "2023-10-05",
                dueDate: getFutureDate(3) // بعد 3 أيام من اليوم
              },
              {
                title: "تحسين أداء الخوادم",
                description: "تحسين كفاءة الخوادم وتقليل وقت الاستجابة",
                priority: "متوسط",
                status: "جديدة",
                progress: 0,
                creationDate: "2023-10-18",
                dueDate: getFutureDate(21) // بعد 21 يوم من اليوم
              }
            ]
          },
          {
            id: 3,
            name: "خالد أحمد",
            email: "khaled@digitalmakers.com",
            role: "member",
            avatar: "https://i.pravatar.cc/150?img=8",
            tasks: [
              {
                title: "تصميم هيكل قاعدة البيانات",
                description: "إنشاء مخطط قاعدة البيانات وتحسين العلاقات بين الجداول",
                priority: "مستعجل",
                status: "مكتملة",
                progress: 100,
                creationDate: "2023-09-25",
                dueDate: getPastDate(5) // قبل 5 أيام من اليوم
              },
              {
                title: "تنفيذ إجراءات التخزين المحسنة",
                description: "كتابة إجراءات التخزين المحسنة لتحسين أداء الاستعلامات",
                priority: "متوسط",
                status: "قيد التنفيذ",
                progress: 40,
                creationDate: "2023-10-15",
                dueDate: getFutureDate(10) // بعد 10 أيام من اليوم
              },
              {
                title: "نسخ احتياطي لقاعدة البيانات",
                description: "إعداد نظام النسخ الاحتياطي التلقائي لقاعدة البيانات",
                priority: "عادي",
                status: "جديدة",
                progress: 0,
                creationDate: "2025-11-11",
                dueDate: getFutureDate(30) // بعد 30 يوم من اليوم
              }
            ]
          }
        ]
      }
    ];
    saveGroupsToStorage();
  }
  renderGroups();
}

// --- دوال مساعدة للتواريخ ---
function getFutureDate(days) {
  const date = new Date();
  date.setDate(date.getDate() + days);
  return date.toISOString().split('T')[0];
}

function getPastDate(days) {
  const date = new Date();
  date.setDate(date.getDate() - days);
  return date.toISOString().split('T')[0];
}

function calculateDaysRemaining(dueDate) {
  const today = new Date();
  const due = new Date(dueDate);
  const diffTime = due - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}

function getDaysRemainingClass(days) {
  if (days < 0) return 'days-danger'; // متأخرة
  if (days <= 2) return 'days-warning'; // قريبة
  if (days <= 7) return 'days-success'; // خلال أسبوع
  return 'days-normal'; // وقت كافي
}

function formatDaysRemaining(days) {
  if (days < 0) return `متأخرة ${Math.abs(days)} يوم`;
  if (days === 0) return 'ينتهي اليوم';
  if (days === 1) return 'يوم واحد متبقي';
  return `${days} أيام متبقية`;
}

// --- إدارة ألمكاتب ---
function openAddGroupModal(){
    document.getElementById('addGroupForm').reset();
    document.getElementById('ownerFields').style.display = 'none';
    document.getElementById('managerFields').style.display = 'none';
    new bootstrap.Modal(document.getElementById('addGroupModal')).show();
}

function addGroup(){
    const name = document.getElementById('groupName').value;
    const desc = document.getElementById('groupDescription').value;
    const field = document.getElementById('groupField').value;
    
    if(name && desc && field){
        const newGroup = {
            id: Date.now(), 
            name, 
            description: desc, 
            field, 
            members: [], 
            tasks: [],
            created: new Date().toLocaleDateString('ar-EG')
        };
        
        groups.push(newGroup);
        saveGroupsToStorage();
        
        bootstrap.Modal.getInstance(document.getElementById('addGroupModal')).hide();
        renderGroups();
        
        // إظهار رسالة نجاح
        showAlert('تم إنشاء المكتب بنجاح!', 'success');
    } else {
        showAlert('يرجى ملء جميع الحقول المطلوبة', 'danger');
    }
}

function toggleOwnerFields() {
  const role = document.getElementById("groupRole").value;
  const ownerFields = document.getElementById("ownerFields");
  const managerFields = document.getElementById("managerFields");

  if (role === "المالك") {
    ownerFields.style.display = "block";
    managerFields.style.display = "none";
  } else if (role === "مدير مكتب المالك") {
    ownerFields.style.display = "none";
    managerFields.style.display = "block";
  } else {
    ownerFields.style.display = "none";
    managerFields.style.display = "none";
  }
}

function renderGroups(){
    const container = document.getElementById('groupsContainer');
    
    if (groups.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="empty-state">
                    <i class="fas fa-building"></i>
                    <h4 class="text-muted">لا توجد مكاتب بعد</h4>
                    <p class="text-muted">ابدأ بإنشاء مكتبك الأول لإدارة فريقك ومهامك</p>
                    <button class="btn btn-primary mt-3" onclick="openAddGroupModal()">
                        <i class="fas fa-plus me-2"></i>إنشاء مكتب جديد
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    groups.forEach(group => {
        const div = document.createElement('div');
        div.className = 'col-lg-4 col-md-6 col-sm-12 mb-4';
        div.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                        <i class="fas fa-building text-white"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-1">${group.name}</h5>
                        <p class="card-text text-muted small mb-0">${group.field}</p>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="openChat('${group.name}')"><i class="fas fa-comments me-2"></i>الدردشة</a></li>
                            <li><a class="dropdown-item" href="#" onclick="openMembers(event, ${group.id})"><i class="fas fa-users me-2"></i>الأعضاء</a></li>
                            <li><a class="dropdown-item" href="#" onclick="openTasksDashboard(${group.id})"><i class="fas fa-tasks me-2"></i>لوحة المهام</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="openAddMemberModal(event, ${group.id})"><i class="fas fa-user-plus me-2"></i>إضافة عضو</a></li>
                        </ul>
                    </div>
                </div>
                <p class="card-text text-muted">${group.description}</p>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="members-count">
                        <i class="fas fa-users text-primary"></i>
                        <span class="ms-1">${group.members.length} أعضاء</span>
                    </div>
                    <div class="tasks-count">
                        <i class="fas fa-tasks text-success"></i>
                        <span class="ms-1">${getGroupTasksCount(group)} مهام</span>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <small class="text-muted">تم الإنشاء في ${group.created}</small>
            </div>
        </div>
        `;
        container.appendChild(div);
    });
}

function getGroupTasksCount(group) {
    let count = 0;
    group.members.forEach(member => {
        if (member.tasks) {
            count += member.tasks.length;
        }
    });
    return count;
}

// --- الدردشة ---
const messages = [];
function openChat(title){
    document.getElementById('chatContainer').style.display='flex';
    document.getElementById('chatTitle').textContent=title;
}
function closeChat(){document.getElementById('chatContainer').style.display='none';}
function sendMessage(){
    const input=document.getElementById('messageInput'); const text=input.value.trim();
    if(text){messages.push({id:messages.length+1,sender:'أنت',content:text,isSent:true}); input.value=''; loadMessages();}
}
function loadMessages(){
    const chatMessages=document.getElementById('chatMessages'); chatMessages.innerHTML='';
    messages.forEach(m=>{
        const div=document.createElement('div'); div.className=`message ${m.isSent?'sent':''}`;
        div.innerHTML=`<div class="message-content"><div>${m.sender}</div><div>${m.content}</div></div>`;
        chatMessages.appendChild(div);
    });
    chatMessages.scrollTop=chatMessages.scrollHeight;
}
document.getElementById('messageInput').addEventListener('keypress',function(e){if(e.key==='Enter'){sendMessage();}});

// --- إدارة الأعضاء ---
function openMembers(event, groupId){
    event.stopPropagation(); 
    document.getElementById('membersContainer').style.display='flex';
    selectedGroup = groups.find(g => g.id === groupId);
    document.getElementById('membersTitle').textContent = `أعضاء ${selectedGroup.name}`;
    renderMembers();
}

function closeMembers(){
    document.getElementById('membersContainer').style.display='none';
}

function renderMembers(){
    const list = document.getElementById('membersList');
    
    if (!selectedGroup.members || selectedGroup.members.length === 0) {
        list.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">لا يوجد أعضاء بعد</h5>
                <p class="text-muted">ابدأ بإضافة أعضاء لفريقك</p>
                <button class="btn btn-primary mt-2" onclick="openAddMemberModal(event, ${selectedGroup.id})">
                    <i class="fas fa-user-plus me-2"></i>إضافة عضو
                </button>
            </div>
        `;
        return;
    }
    
    list.innerHTML = '';
    
    selectedGroup.members.forEach(member => {
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center justify-content-between p-3 border-bottom';
        div.innerHTML = `
            <div class="d-flex align-items-center">
                <img src="${member.avatar || 'https://via.placeholder.com/40'}" class="img-radius wid-40 me-3">
                <div>
                    <h6 class="mb-1">${member.name}</h6>
                    <p class="text-muted small mb-0">${member.email}</p>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">${getRoleText(member.role)}</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-info" onclick="openMemberDetails(${member.id})">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="openAddTaskModal(${member.id})">
                        <i class="fas fa-tasks"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMember(${member.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        list.appendChild(div);
    });
}

function getRoleText(role) {
    const roles = {
        'member': 'عضو',
        'admin': 'مدير',
        'moderator': 'مشرف'
    };
    return roles[role] || role;
}

function deleteMember(id){
    if(confirm('هل تريد حذف هذا العضو؟')){
        selectedGroup.members = selectedGroup.members.filter(m => m.id !== id);
        saveGroupsToStorage();
        renderMembers();
        showAlert('تم حذف العضو بنجاح', 'success');
    }
}

// --- لوحة متابعة المهام ---
function openTasksDashboard(groupId) {
    selectedGroup = groups.find(g => g.id === groupId);
    document.getElementById('tasksDashboardTitle').textContent = `لوحة متابعة المهام - ${selectedGroup.name}`;
    document.getElementById('tasksDashboardContainer').style.display = 'flex';
    updateTasksDashboard();
}

function closeTasksDashboard() {
    document.getElementById('tasksDashboardContainer').style.display = 'none';
}

function updateTasksDashboard() {
    // حساب إحصائيات المهام
    let totalTasks = 0;
    let completedTasks = 0;
    let inProgressTasks = 0;
    let delayedTasks = 0;
    
    selectedGroup.members.forEach(member => {
        if (member.tasks) {
            totalTasks += member.tasks.length;
            member.tasks.forEach(task => {
                if (task.status === 'مكتملة') completedTasks++;
                else if (task.status === 'قيد التنفيذ') inProgressTasks++;
                else if (task.status === 'متأخرة') delayedTasks++;
                else inProgressTasks++; // إذا لم يكن هناك حالة، تعتبر قيد التنفيذ
            });
        }
    });
    
    // تحديث العدادات
    document.getElementById('totalTasksCount').textContent = totalTasks;
    document.getElementById('completedTasksCount').textContent = completedTasks;
    document.getElementById('inProgressTasksCount').textContent = inProgressTasks;
    document.getElementById('delayedTasksCount').textContent = delayedTasks;
    
    // عرض المهام
    renderTasksList();
    
    // عرض أداء الأعضاء
    renderMembersPerformance();
}

function renderTasksList() {
    const container = document.getElementById('tasksListContainer');
    
    if (getGroupTasksCount(selectedGroup) === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-tasks fa-2x text-muted mb-3"></i>
                <h5 class="text-muted">لا توجد مهام بعد</h5>
                <p class="text-muted">ابدأ بإضافة مهام لأعضاء فريقك</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    selectedGroup.members.forEach(member => {
        if (member.tasks && member.tasks.length > 0) {
            member.tasks.forEach(task => {
                const daysRemaining = calculateDaysRemaining(task.dueDate);
                const daysClass = getDaysRemainingClass(daysRemaining);
                const daysText = formatDaysRemaining(daysRemaining);
                
                const taskCard = document.createElement('div');
                taskCard.className = `card task-card mb-3 task-${getTaskStatusClass(task.status || 'جديدة')}`;
                taskCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title">${task.title}</h6>
                            <div>
                                <span class="badge bg-${getTaskStatusBadgeColor(task.status || 'جديدة')} me-1">${task.status || 'جديدة'}</span>
                                <span class="days-remaining ${daysClass}">${daysText}</span>
                            </div>
                        </div>
                        <p class="card-text small text-muted">${task.description}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-${getPriorityBadgeColor(task.priority)} me-2">${task.priority}</span>
                                <small class="text-muted">${member.name}</small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="changeTaskStatus(${member.id}, '${task.title}', 'قيد التنفيذ')">قيد التنفيذ</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="changeTaskStatus(${member.id}, '${task.title}', 'مكتملة')">مكتملة</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="changeTaskStatus(${member.id}, '${task.title}', 'متأخرة')">متأخرة</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteTask(${member.id}, '${task.title}')">حذف</a></li>
                                </ul>
                            </div>
                        </div>
                        ${task.progress !== undefined ? `
                        <div class="mt-3">
                            <div class="d-flex justify-content-between small mb-1">
                                <span>التقدم</span>
                                <span>${task.progress}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-${getProgressBarColor(task.progress)}" role="progressbar" style="width: ${task.progress}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="far fa-calendar me-1"></i>
                                تاريخ الاستحقاق: ${formatDate(task.dueDate)}
                            </small>
                        </div>
                    </div>
                `;
                container.appendChild(taskCard);
            });
        }
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function renderMembersPerformance() {
    const container = document.getElementById('membersPerformanceContainer');
    container.innerHTML = '';
    
    if (!selectedGroup.members || selectedGroup.members.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">لا يوجد أعضاء لعرض أدائهم</p>';
        return;
    }
    
    selectedGroup.members.forEach(member => {
        if (member.tasks) {
            const totalTasks = member.tasks.length;
            const completedTasks = member.tasks.filter(t => t.status === 'مكتملة').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // حساب المهام المتأخرة
            const overdueTasks = member.tasks.filter(t => {
                const daysRemaining = calculateDaysRemaining(t.dueDate);
                return daysRemaining < 0 && t.status !== 'مكتملة';
            }).length;
            
            const performanceCard = document.createElement('div');
            performanceCard.className = 'member-performance-card card mb-2';
            performanceCard.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <img src="${member.avatar || 'https://via.placeholder.com/40'}" class="img-radius wid-40 me-3">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">${member.name}</h6>
                            <small class="text-muted">${completedTasks}/${totalTasks} مكتملة</small>
                            ${overdueTasks > 0 ? `<br><small class="text-danger">${overdueTasks} متأخرة</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${getPerformanceBadgeColor(completionRate)}">${completionRate}%</span>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-${getPerformanceBadgeColor(completionRate)}" role="progressbar" style="width: ${completionRate}%"></div>
                    </div>
                </div>
            `;
            performanceCard.addEventListener('click', () => openMemberDetails(member.id));
            container.appendChild(performanceCard);
        }
    });
}

function changeTaskStatus(memberId, taskTitle, newStatus) {
    const member = selectedGroup.members.find(m => m.id === memberId);
    if (member && member.tasks) {
        const task = member.tasks.find(t => t.title === taskTitle);
        if (task) {
            task.status = newStatus;
            saveGroupsToStorage();
            updateTasksDashboard();
            showAlert('تم تحديث حالة المهمة', 'success');
        }
    }
}

function deleteTask(memberId, taskTitle) {
    if (confirm('هل تريد حذف هذه المهمة؟')) {
        const member = selectedGroup.members.find(m => m.id === memberId);
        if (member && member.tasks) {
            member.tasks = member.tasks.filter(t => t.title !== taskTitle);
            saveGroupsToStorage();
            updateTasksDashboard();
            showAlert('تم حذف المهمة', 'success');
        }
    }
}

function filterTasks(status) {
    // في تطبيق حقيقي، هنا سيتم تصفية المهام حسب الحالة
    alert(`سيتم تصفية المهام حسب الحالة: ${status}`);
}

function exportTasksReport(format) {
    alert(`سيتم تصدير التقرير بصيغة ${format.toUpperCase()}. هذه الميزة قيد التطوير.`);
}

// --- صفحة تفاصيل العضو ---
function openMemberDetails(memberId) {
    selectedMemberDetailsId = memberId;
    const member = selectedGroup.members.find(m => m.id === memberId);
    
    if (member) {
        // في تطبيق حقيقي، هنا سيتم فتح نافذة تفاصيل العضو
        alert(`سيتم فتح صفحة تفاصيل العضو: ${member.name}`);
    }
}

// --- إضافة مهمة ---
function openAddTaskModal(memberId){
    selectedMemberId = memberId;
    document.getElementById('addTaskForm').reset();
    
    // تعيين تاريخ افتراضي (بعد أسبوع من اليوم)
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    document.getElementById('taskDueDate').value = nextWeek.toISOString().split('T')[0];
    
    new bootstrap.Modal(document.getElementById('addTaskModal')).show();
}

function addTask(){
    const title = document.getElementById('taskTitle').value;
    const desc = document.getElementById('taskDescription').value;
    const priority = document.getElementById('taskPriority').value;
    const dueDate = document.getElementById('taskDueDate').value;
    
    if(title && desc && dueDate){
        const member = selectedGroup.members.find(m => m.id === selectedMemberId);
        if(!member.tasks) member.tasks = [];
        
        // إضافة تاريخ إنشاء المهمة
        const creationDate = new Date().toLocaleDateString('ar-EG');
        
        member.tasks.push({
            title, 
            description: desc, 
            priority, 
            status: 'جديدة',
            creationDate,
            dueDate: dueDate,
            progress: 0
        });
        
        saveGroupsToStorage();
        bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
        showAlert('تم إضافة المهمة للعضو', 'success');
        
        // تحديث لوحة المهام إذا كانت مفتوحة
        if (document.getElementById('tasksDashboardContainer').style.display === 'flex') {
            updateTasksDashboard();
        }
        
        // تحديث قائمة الأعضاء إذا كانت مفتوحة
        if (document.getElementById('membersContainer').style.display === 'flex') {
            renderMembers();
        }
    } else {
        showAlert('يرجى ملء جميع الحقول', 'danger');
    }
}

// --- إضافة عضو ---
function openAddMemberModal(event, groupId){
    event.stopPropagation(); 
    selectedGroup = groups.find(g => g.id === groupId);
    document.getElementById('searchMember').value = ''; 
    document.getElementById('searchResult').innerHTML = '';
    document.getElementById('addSection').style.display = 'none'; 
    document.getElementById('addMemberBtn').style.display = 'none';
    new bootstrap.Modal(document.getElementById('addMemberModal')).show();
}

document.getElementById('searchMember').addEventListener('input', function(){
    const query = this.value.toLowerCase();
    const resultDiv = document.getElementById('searchResult');
    const found = selectedGroup.members.filter(m => m.name.toLowerCase().includes(query));
    
    if(query.length === 0){
        resultDiv.innerHTML = ''; 
        document.getElementById('addSection').style.display = 'none'; 
        document.getElementById('addMemberBtn').style.display = 'none'; 
        return;
    }
    
    if(found.length > 0){
        resultDiv.innerHTML = `<div class="alert alert-info">تم العثور على ${found.length} عضو</div>`;
        document.getElementById('addSection').style.display = 'none'; 
        document.getElementById('addMemberBtn').style.display = 'none';
    } else {
        resultDiv.innerHTML = '<div class="alert alert-warning">العضو غير موجود، الرجاء إضافة جديد</div>';
        document.getElementById('addSection').style.display = 'block'; 
        document.getElementById('addMemberBtn').style.display = 'inline-block';
    }
});

function addMember(){
    const name = document.getElementById('memberName').value;
    const email = document.getElementById('memberEmail').value;
    const role = document.getElementById('memberRole').value;
    
    if(name && email){
        selectedGroup.members.push({
            id: Date.now(),
            name,
            email,
            role,
            avatar: "https://via.placeholder.com/40",
            tasks: []
        });
        
        saveGroupsToStorage();
        bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
        
        // تحديث العرض
        if (document.getElementById('membersContainer').style.display === 'flex') {
            renderMembers();
        }
        
        showAlert('تم إضافة العضو بنجاح', 'success');
    } else {
        showAlert('يرجى ملء جميع الحقول', 'danger');
    }
}

// --- دوال مساعدة ---
function getTaskStatusClass(status) {
    switch(status) {
        case 'جديدة': return 'new';
        case 'قيد التنفيذ': return 'inprogress';
        case 'مكتملة': return 'completed';
        case 'متأخرة': return 'delayed';
        default: return 'new';
    }
}

function getTaskStatusBadgeColor(status) {
    switch(status) {
        case 'جديدة': return 'info';
        case 'قيد التنفيذ': return 'warning';
        case 'مكتملة': return 'success';
        case 'متأخرة': return 'danger';
        default: return 'secondary';
    }
}

function getPriorityBadgeColor(priority) {
    switch(priority) {
        case 'عادي': return 'secondary';
        case 'متوسط': return 'warning';
        case 'مستعجل': return 'danger';
        default: return 'secondary';
    }
}

function getPerformanceBadgeColor(rate) {
    if (rate >= 80) return 'success';
    if (rate >= 60) return 'warning';
    return 'danger';
}

function getProgressBarColor(progress) {
    if (progress >= 80) return 'success';
    if (progress >= 50) return 'warning';
    return 'info';
}

function saveGroupsToStorage() {
    localStorage.setItem('officeGroups', JSON.stringify(groups));
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // إزالة التنبيه تلقائياً بعد 3 ثوان
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

// تهيئة التطبيق عند التحميل
document.addEventListener('DOMContentLoaded', function() {
    initializeSampleData();
});
</script>

</body>
</html>