<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>شجرة العائلة (مؤقتة)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4" >

<h2 class="mb-3 text-primary">  ( المجال)</h2>

<div class="row mb-3">
  <div class="col-md-3">
    <label>المجال</label>
    <select id="grandParent" class="form-select">
      <option value="">اختر المجال</option>
    </select>
  </div>
  <div class="col-md-3">
    <label>الفرع</label>
    <select id="parent" class="form-select">
      <option value="">اختر الفرع</option>
    </select>
  </div>
  <div class="col-md-3">
    <label>القسم</label>
    <select id="child" class="form-select">
      <option value="">اختر القسم</option>
    </select>
  </div>
  <div class="col-md-3">
    <label> التخصص</label>
    <select id="grandChild" class="form-select">
      <option value="">اختر  التخصص</option>
    </select>
  </div>
</div>

<div class="text-end mb-3">
  <button class="btn btn-success" id="addMemberBtn">➕ إضافة مجال</button>
</div>

<!-- نافذة الإضافة -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">إضافة مجال جديد</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="memberName" class="form-control mb-2" placeholder="الاسم">
        <select id="memberParent" class="form-select">
          <option value="">اختر المجال الاب (اختياري)</option>
        </select>
      </div>  
      <div class="modal-footer">
        <button class="btn btn-primary" id="saveMember">حفظ</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ✅ بيانات مؤقتة فقط في الذاكرة
  let familyData = [];

  function refreshSelects() {
    const grandParents = familyData.filter(x => x.parentId === null);
    const parents = familyData.filter(x => x.parentId !== null);

    populateSelect($("#grandParent"), grandParents, "اختر المجال");
    populateSelect($("#memberParent"), familyData, "اختر الاب للمجال المضاف (اختياري)");
  }

  function populateSelect(select, items, placeholder) {
    select.empty();
    select.append(`<option value="">${placeholder}</option>`);
    items.forEach(i => {
      select.append(`<option value="${i.id}">${i.name}</option>`);
    });
  }

  $("#addMemberBtn").click(() => {
    $("#memberName").val("");
    refreshSelects();
    new bootstrap.Modal(document.getElementById("addModal")).show();
  });

  $("#saveMember").click(() => {
    const name = $("#memberName").val().trim();
    const parentId = $("#memberParent").val() || null;
    if (!name) return alert("الرجاء إدخال الاسم");

    const id = familyData.length ? Math.max(...familyData.map(x => x.id)) + 1 : 1;
    familyData.push({ id, name, parentId: parentId ? Number(parentId) : null });

    refreshSelects();
    alert("تمت الإضافة مؤقتًا ✅");
    bootstrap.Modal.getInstance(document.getElementById("addModal")).hide();
  });

  // تحديث القوائم عندما يختار المستخدم جد/أب
  $("#grandParent, #parent, #child").on("change", function () {
    const selectedId = Number($(this).val());
    const children = familyData.filter(x => x.parentId === selectedId);
    if (this.id === "grandParent") populateSelect($("#parent"), children, "اختر الفرع");
    if (this.id === "parent") populateSelect($("#child"), children, "اختر القسم");
    if (this.id === "child") populateSelect($("#grandChild"), children, "اختر  التخصص");
  });

  // تحميل أولي فارغ
  refreshSelects();
</script>

</body>
</html>
