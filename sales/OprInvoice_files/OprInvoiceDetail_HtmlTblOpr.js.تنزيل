var UpdateUnitPrice = function () {
    var _ItemId = $("#ItemId option:selected").text();

    //var splitArray = _ItemId.split(":");
    GeneratePriceDropdown(_ItemId);

    //var _IsVat = $("#IsVat").val();
    //var _ItemVAT;
    //if (_IsVat == "Yes") {
    //    _ItemVAT = parseFloat(splitArray[10]);
    //    $("#ItemVAT").val(_ItemVAT);
    //}
    //else {
    //    $("#ItemVAT").val(0);
    //}

    onchangeQuantity();
}
 
 


 


 

var AddOprInvoicesDetailsHTMLRow = function () {
    AddOprInvoiceDetail();
    $("#ItemBarcode").val('');
}

var AddHTMLTableRow = function (result) {
    var Stk_ItemUnit;
     $.each(result.listStk_ItemUnit, function (index, item) {
        if (item.MAIN === 1)
            Stk_ItemUnit = item;
    });

    var tBody = $("#tblOprInvoiceDetail > TBODY")[0];
    var row = tBody.insertRow(-1);

    //############## test #########
    var table1 = document.getElementById("tblOprInvoiceDetail");
    var rows1 = table1.getElementsByTagName("tr");
    var TR_ID = rows1.length - 2;
    //for (var i = 1; i < rows1.length; i++) {
    //    alert("Row " + i + " of the table.");
    //}
    //  var cell = $(row.insertCell(-1));

    //cell.attr("id", "ID"  + TR_ID); // Add an id to the new cell
    //var label = $("<label>").text(TR_ID);
    //cell.css("background-color", "#88a7c5");
    //cell.css("color", "#000");
    //cell.append(label);
  
    //#####################
    //#####################
    var cell = $(row.insertCell(-1));
    cell.css("background-color", "#88a7c5");
    cell.css("color", "#000");
    //cell.css("visibility", "hidden"); // إضافة خاصية visibility
    var txtcID = $("<input />");
    txtcID.attr('class', 'form-control');
    txtcID.attr('style', 'width:100%; text-align:center;');
    txtcID.attr('type', 'text');
    txtcID.attr('min', '1');
    txtcID.attr('id', 'ID' + TR_ID);
    txtcID.val(TR_ID);
    txtcID.attr('readonly', 'readonly');
    cell.append(txtcID);
    //################################
    var cell = $(row.insertCell(-1));
    var txtcCode1 = $("<input />");
    txtcCode1.attr('class', 'form-control');
    txtcCode1.attr('style',  'width:100%; text-align:center;');
    txtcCode1.attr('type', 'number');
    txtcCode1.attr('min', '1');
    txtcCode1.attr('id', 'Code1' + TR_ID);
    txtcCode1.attr("onchange", "AddOprInvoiceDetail($(this).val());");
    //txtcCode1.val($("#Quantity").val());
    txtcCode1.val(result.code1);
    cell.append(txtcCode1);
    //################################

    var cell = $(row.insertCell(-1));
    //var _ItemName = $("#ItemId option:selected").text();
    //var splitArray = _ItemName.split(":");
    var inputItemName = $("<input />");
    inputItemName.attr('class', 'form-control');
    inputItemName.attr("rows", "1");
    inputItemName.attr('style',  'width:100%;');
    inputItemName.attr('id', 'ItemName' + TR_ID);
    //inputItemName.val(splitArray[0]);
    inputItemName.val(result.INAME);
    cell.append(inputItemName);


    var cell = $(row.insertCell(-1));
    var txtQuantity = $("<input />");
    txtQuantity.attr('class', 'form-control');
    txtQuantity.attr('style',  'width:100%; text-align:center;');
    txtQuantity.attr('type', 'number');
    txtQuantity.attr('min', '1');
    txtQuantity.attr('id', 'Quantity' + TR_ID);
    txtQuantity.attr("onchange", "GrantTotalTable(false);");
    //txtQuantity.val($("#Quantity").val());
    txtQuantity.val("1");

    cell.append(txtQuantity);

    var cell = $(row.insertCell(-1));
    //var _UnitPrice = $("#UnitPrice option:selected").text();
    //var splitUnitPrice = _UnitPrice.split(":");
    //_UnitPrice = splitUnitPrice[1];

    var txtUnite = $("<select />");
    txtUnite.attr('style',  'width:100%; text-align:center;');
    txtUnite.attr('class', 'form-control');
     //txtUnite.attr('type', 'number');
    txtUnite.attr('min', '1');
    txtUnite.attr('id', 'Unit' + TR_ID);
    txtUnite.attr("onchange", "UpdateSelected_Unite(this," + result.code1 + " ," + TR_ID+");");
   
    //txtUnite.val(parseFloat(_UnitPrice));
    //txtUnite.val(parseFloat(result.mbea));
    cell.append(txtUnite);

    //############ تعبئة الوحدات #########
    var $unitDropdown = $('#Unit' + TR_ID);
    //$unitPriceDropdown.empty(); // Clear any existing options\

    // Populate the dropdown with the Stk_ItemUnit list
    $.each(result.listStk_ItemUnit, function (index, item) {
        $unitDropdown.append('<option value="' + item.seq + '">' + item.unitn + '</option>');
    });
  
    $('#Unit' + TR_ID).val(Stk_ItemUnit.seq);
    $("select").select2({
        tags: true
    });
    //###########  نهاية تعبئة الوحدات #######
    var cell = $(row.insertCell(-1));
    var txtItemDiscount = $("<input />");
    txtItemDiscount.attr('type', 'number');
    txtItemDiscount.attr('class', 'form-control');
    txtQuantity.attr('style',  'width:100%; text-align:center;');
    txtItemDiscount.attr('id', 'ItemDiscount' + TR_ID);
    txtItemDiscount.attr("onchange", "GrantTotalTable(false);");
    //txtItemDiscount.val($("#ItemDiscount").val());
    txtItemDiscount.val("0");
    cell.append(txtItemDiscount);
    var cell = $(row.insertCell(-1));
    //var _UnitPrice = $("#UnitPrice option:selected").text();
    //var splitUnitPrice = _UnitPrice.split(":");
    //_UnitPrice = splitUnitPrice[1];

    var txtUnitPrice = $("<input />");
    txtUnitPrice.attr('style',  'width:100%; text-align:center;');
    txtUnitPrice.attr('class', 'form-control');
     txtUnitPrice.attr('type', 'number');
    txtUnitPrice.attr('min', '1');
    txtUnitPrice.attr('id', 'UnitPrice' + TR_ID);
    txtUnitPrice.attr("onchange", "GrantTotalTable(false);");
    //txtUnitPrice.val(parseFloat(_UnitPrice));
    txtUnitPrice.val(parseFloat(Stk_ItemUnit.BEAG));
    cell.append(txtUnitPrice);

    var cell = $(row.insertCell(-1));
    var txtTotal = $("<input />");
    txtTotal.attr('style',  'width:100%; text-align:center;');
    txtTotal.attr('class', 'form-control');
    txtTotal.attr('type', 'number');
    txtTotal.attr('min', '1');
    txtTotal.attr('id', 'Total' + TR_ID);
    txtTotal.attr("onchange", "GrantTotalTable(false);");
    //txtTotal.val(parseFloat(_UnitPrice));
    txtTotal.val(0);
    cell.append(txtTotal);

    var cell = $(row.insertCell(-1));
    var txtTotal = $("<input />");
    txtTotal.attr('style',  'width:100%; text-align:center;');
    txtTotal.attr('class', 'form-control');
    txtTotal.attr('type', 'number');
    txtTotal.attr('min', '1');
    txtTotal.attr('id', 'ItemVAT' + TR_ID);
    txtTotal.attr("onchange", "GrantTotalTable(false);");
    //txtTotal.val(parseFloat(_UnitPrice));
    txtTotal.val(result.MRSLA);
    cell.append(txtTotal);


    var cell = $(row.insertCell(-1));
    var txttotal_vat = $("<input />");
    txttotal_vat.attr('style',  'width:100%; text-align:center;');
    txttotal_vat.attr('class', 'form-control');
    txttotal_vat.attr('type', 'number');
    txttotal_vat.attr('min', '1');
    txttotal_vat.attr('id', 'Total_vat' + TR_ID);
    txttotal_vat.attr("onchange", "GrantTotalTable(false);");
    //txttotal_vat.val(parseFloat(_UnitPrice));
    txttotal_vat.val(0);
    cell.append(txttotal_vat);

    var cell = $(row.insertCell(-1));
    var txtcode2 = $("<input />");
    txtcode2.attr('style',  'width:100%; text-align:center;');
    txtcode2.attr('class', 'form-control');
    txtcode2.attr('type', 'number');
    txtcode2.attr('min', '1');
    txtcode2.attr('id', 'code2' + TR_ID);
    txtcode2.attr("onchange", "");
    txtcode2.val(parseFloat(Stk_ItemUnit.code2));
     cell.append(txtcode2);

    var cell = $(row.insertCell(-1));
    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    txtTotal2.attr('type', 'number');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'Total2' +  TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    //txtTotal2.val(parseFloat(_UnitPrice));
    txtTotal2.val(0);
    cell.append(txtTotal2);

    //var btnUpdate = $("<input />");
    //btnUpdate.attr("type", "button");
    //btnUpdate.attr('class', 'btn btn-success btn-xs');
    //btnUpdate.attr('id', 'btnUpdateOprInvoicesDetail' + result.code1);
    //btnUpdate.attr("onclick", "UpdateOprInvoiceDetail(this);");
    //btnUpdate.val("Update");
    //cell.append(btnUpdate);
    //########################### hiden dev ######
    //var cell = $(row.insertCell(-1));

    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    //txtTotal2.attr('type', 'number');
    txtTotal2.attr('type', 'hidden');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'AVG_PRC_SAL' + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    txtTotal2.val(Stk_ItemUnit.AVG_PRC_SAL);
     cell.append(txtTotal2);

    //var cell = $(row.insertCell(-1));

    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    //txtTotal2.attr('type', 'number');
    txtTotal2.attr('type', 'hidden');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'searg' + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    txtTotal2.val(Stk_ItemUnit.searg);
    cell.append(txtTotal2);

    //var cell = $(row.insertCell(-1));

    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    //txtTotal2.attr('type', 'number');
    txtTotal2.attr('type', 'hidden');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'lst_prc_buy' + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    txtTotal2.val(Stk_ItemUnit.lst_prc_buy);
    cell.append(txtTotal2);
    //var cell = $(row.insertCell(-1));

    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    //txtTotal2.attr('type', 'number');
    txtTotal2.attr('type', 'hidden');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'beag' + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    txtTotal2.val(Stk_ItemUnit.beag);
    cell.append(txtTotal2);
        //var cell = $(row.insertCell(-1));

    var txtItm_Ser = $("<input />");
    txtItm_Ser.attr('style',  'width:100%; text-align:center;');
    txtItm_Ser.attr('class', 'form-control');
    //txtItm_Ser.attr('type', 'number');
    txtItm_Ser.attr('type', 'hidden');
    txtItm_Ser.attr('min', '1');
    txtItm_Ser.attr('id', 'Itm_Ser' + TR_ID);
    //txtItm_Ser.attr("onchange", "GrantTotalTable(false);");
    txtItm_Ser.val(Stk_ItemUnit.ITM_SER);
    cell.append(txtItm_Ser);
        //var cell = $(row.insertCell(-1));

    var txtaddkta = $("<input />");
    txtaddkta.attr('style',  'width:100%; text-align:center;');
    txtaddkta.attr('class', 'form-control');
    //txtaddkta.attr('type', 'number');
    txtaddkta.attr('type', 'hidden');
    txtaddkta.attr('min', '1');
    txtaddkta.attr('id', 'addkta' + TR_ID);
    txtaddkta.attr("onchange", "GrantTotalTable(false);");
    txtaddkta.val(Stk_ItemUnit.addkta);
    cell.append(txtaddkta);
        //var cell = $(row.insertCell(-1));

    var txtctg_ser = $("<input />");
    txtctg_ser.attr('style',  'width:100%; text-align:center;');
    txtctg_ser.attr('class', 'form-control');
    //txtctg_ser.attr('type', 'number');
    txtctg_ser.attr('type', 'hidden');
    txtctg_ser.attr('min', '1');
    txtctg_ser.attr('id', 'ctg_ser' + TR_ID);
    //txtctg_ser.attr("onchange", "GrantTotalTable(false);");
    txtctg_ser.val(Stk_ItemUnit.ctg_ser);
    cell.append(txtctg_ser);
        //var cell = $(row.insertCell(-1));

    var txtNOTS_ITEMS = $("<input />");
    txtNOTS_ITEMS.attr('style',  'width:100%; text-align:center;');
    txtNOTS_ITEMS.attr('class', 'form-control');
    //txtNOTS_ITEMS.attr('type', 'number');
    txtNOTS_ITEMS.attr('type', 'hidden');
    txtNOTS_ITEMS.attr('min', '1');
    txtNOTS_ITEMS.attr('id', 'NOTS_ITEMS' + TR_ID);
    //txtNOTS_ITEMS.attr("onchange", "GrantTotalTable(false);");
    //txtNOTS_ITEMS.val(Stk_ItemUnit.beag);
    cell.append(txtNOTS_ITEMS);
    
    //########################### hiden dev ######

    var cell = $(row.insertCell(-1));

    var btnRemove = $("<input />");
    btnRemove.attr("type", "button");
    btnRemove.attr('class', 'btn btn-danger btn-xs');
    btnRemove.attr("onclick", "Remove(this);");
    btnRemove.val(" X ");
    cell.append(btnRemove);

 
  //  UpdateItemDynamicControl(this); //دالة الحساب 
     ClearInvoiceItemTableRowData();
    GrantTotalTable(true);


}


function LoadTableRowFromDB(result, index) {
    var Stk_ItemUnit;
    $.each(result.Stk_Item_code1.listStk_ItemUnit, function (index, item) {
        if (item.seq === result.Unt_Ser) {
            Stk_ItemUnit = item;
         }
    });

    var tBody = $("#tblOprInvoiceDetail > TBODY")[0];
    var row = tBody.insertRow(-1);

    //############## test #########
    var table1 = document.getElementById("tblOprInvoiceDetail");
    var rows1 = table1.getElementsByTagName("tr");
    var TR_ID = rows1.length - 2;
    //for (var i = 1; i < rows1.length; i++) {
    //    alert("Row " + i + " of the table.");
    //}
    //var cell = $(row.insertCell(-1));

    //cell.attr("id", "ID"  + TR_ID); // Add an id to the new cell
    //var label = $("<label>").text(TR_ID);
    //cell.css("background-color", "#88a7c5");
    //cell.css("color", "#000");
    //cell.append(label);

    ////#####################
    var cell = $(row.insertCell(-1));
    cell.css("background-color", "#88a7c5");
    cell.css("color", "#000");
    //cell.css("visibility", "hidden"); // إضافة خاصية visibility
    var txtcID = $("<input />");
    txtcID.attr('class', 'form-control');
    txtcID.attr('style', 'width:100%; text-align:center;');
    txtcID.attr('type', 'text');
    txtcID.attr('min', '1');
    txtcID.attr('id', 'ID' + TR_ID);
    txtcID.val(TR_ID);
    txtcID.attr('readonly', 'readonly');
    cell.append(txtcID);
    //################################

    //#####################
    var cell = $(row.insertCell(-1));
    var txtcCode1 = $("<input />");
    txtcCode1.attr('class', 'form-control');
    txtcCode1.attr('style',  'width:100%; text-align:center;');
    txtcCode1.attr('type', 'number');
    txtcCode1.attr('min', '1');
    txtcCode1.attr('id', 'Code1' + TR_ID);
    txtcCode1.attr("onchange", "AddOprInvoiceDetail($(this).val());");
    //txtcCode1.val($("#Quantity").val());
    txtcCode1.val(result.code1);
    cell.append(txtcCode1);
    //################################

    var cell = $(row.insertCell(-1));
    //var _ItemName = $("#ItemId option:selected").text();
    //var splitArray = _ItemName.split(":");
    var inputItemName = $("<input />");
    inputItemName.attr('class', 'form-control');
    inputItemName.attr("rows", "1");
    inputItemName.attr('style',  'width:100%; ');
    inputItemName.attr('id', 'ItemName'  + TR_ID);
    //inputItemName.val(splitArray[0]);
    inputItemName.val(result.Stk_Item_code1.INAME);
    cell.append(inputItemName);


    var cell = $(row.insertCell(-1));
    var txtQuantity = $("<input />");
    txtQuantity.attr('style',  'width:100%; text-align:center;');
    txtQuantity.attr('class', 'form-control');
    txtQuantity.attr('type', 'number');
    txtQuantity.attr('min', '1');
    txtQuantity.attr('id', 'Quantity'  + TR_ID);
    txtQuantity.attr("onchange", "GrantTotalTable(false);");
    //txtQuantity.val($("#Quantity").val());
    txtQuantity.val(result.Qty);

    cell.append(txtQuantity);

    var cell = $(row.insertCell(-1));

    var txtUnite = $("<select />");
    txtUnite.attr('style',  'width:100%; text-align:center;');
    txtUnite.attr('class', 'form-control');
    //txtUnite.attr('type', 'number');
    txtUnite.attr('min', '1');
    txtUnite.attr('id', 'Unit' + TR_ID);
    txtUnite.attr("onchange", "UpdateSelected_Unite(this," + result.code1 + " ," + TR_ID +");");

    //txtUnite.attr("onchange", "UpdateItemDynamicControl(this);");
    //txtUnite.val(parseFloat(_UnitPrice));
    //txtUnite.val(parseFloat(result.mbea));
    cell.append(txtUnite);

    //############ تعبئة الوحدات #########
    var $unitDropdown = $('#Unit' +  TR_ID);
    //$unitPriceDropdown.empty(); // Clear any existing options\

    // Populate the dropdown with the Stk_ItemUnit list
    $.each(result.Stk_Item_code1.listStk_ItemUnit, function (index, item) {
        $unitDropdown.append('<option value="' + item.seq + '">' + item.unitn + '</option>');
    });
  
    $('#Unit' + TR_ID).val(result.Unt_Ser);
    $("select").select2({
        tags: true
    });
    //###########  نهاية تعبئة الوحدات #######
    var cell = $(row.insertCell(-1));
    var txtItemDiscount = $("<input />");
    txtItemDiscount.attr('class', 'form-control');
    txtItemDiscount.attr('type', 'number');
    txtQuantity.attr('style',  'width:100%; text-align:center;');
    txtItemDiscount.attr('id', 'ItemDiscount'  + TR_ID);
    txtItemDiscount.attr("onchange", "GrantTotalTable(false);");
    //txtItemDiscount.val($("#ItemDiscount").val());
    txtItemDiscount.val(result.ktai);
    cell.append(txtItemDiscount);


    var cell = $(row.insertCell(-1));
    //var _UnitPrice = $("#UnitPrice option:selected").text();
    //var splitUnitPrice = _UnitPrice.split(":");
    //_UnitPrice = splitUnitPrice[1];
     var txtUnitPrice = $("<input />");
    txtUnitPrice.attr('style',  'width:100%; text-align:center;');
    txtUnitPrice.attr('class', 'form-control');
    txtUnitPrice.attr('type', 'number');
    txtUnitPrice.attr('min', '1');
    txtUnitPrice.attr('id', 'UnitPrice'  + TR_ID);
    txtUnitPrice.attr("onchange", "GrantTotalTable(false);");
    //txtUnitPrice.val(parseFloat(_UnitPrice));
    txtUnitPrice.val(parseFloat(result.Price));
    cell.append(txtUnitPrice);

    var cell = $(row.insertCell(-1));
        var txtTotal = $("<input />");
    txtTotal.attr('style',  'width:100%; text-align:center;');
    txtTotal.attr('class', 'form-control');
    txtTotal.attr('type', 'number');
    txtTotal.attr('min', '1');
    txtTotal.attr('id', 'Total' + TR_ID);
    txtTotal.attr("onchange", "");
    //txtTotal.val(parseFloat(_UnitPrice));
    txtTotal.val(0);
    cell.append(txtTotal);

    var cell = $(row.insertCell(-1));
    var txtTotal = $("<input />");
    txtTotal.attr('style',  'width:100%; text-align:center;');
    txtTotal.attr('class', 'form-control');
    txtTotal.attr('type', 'number');
    txtTotal.attr('min', '1');
    txtTotal.attr('id', 'ItemVAT' + TR_ID);
    txtTotal.attr("onchange", "GrantTotalTable(false);");
    //txtTotal.val(parseFloat(_UnitPrice));
    txtTotal.val(result.pur_inv_no);
    cell.append(txtTotal);

 
    var cell = $(row.insertCell(-1));
    var txttotal_vat = $("<input />");
    txttotal_vat.attr('style',  'width:100%; text-align:center;');
    txttotal_vat.attr('class', 'form-control');
    txttotal_vat.attr('type', 'number');
    txttotal_vat.attr('min', '1');
    txttotal_vat.attr('id', 'Total_vat' + TR_ID);
    txttotal_vat.attr("onchange", "GrantTotalTable(false);");
    //txttotal_vat.val(parseFloat(_UnitPrice));
    txttotal_vat.val(0);
    cell.append(txttotal_vat);

    var cell = $(row.insertCell(-1));
    var txtcode2 = $("<input />");
    txtcode2.attr('style',  'width:100%; text-align:center;');
    txtcode2.attr('class', 'form-control');
    txtcode2.attr('type', 'number');
    txtcode2.attr('min', '1');
    txtcode2.attr('id', 'code2' +  TR_ID);
    txtcode2.attr("onchange", "");
    txtcode2.val(Stk_ItemUnit.code2);
     cell.append(txtcode2);

    var cell = $(row.insertCell(-1));
    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    txtTotal2.attr('type', 'number');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'Total2'  + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    //txtTotal2.val(parseFloat(_UnitPrice));
    txtTotal2.val(0);
    cell.append(txtTotal2);

    //var btnUpdate = $("<input />");
    //btnUpdate.attr("type", "button");
    //btnUpdate.attr('class', 'btn btn-success btn-xs');
    //btnUpdate.attr('id', 'btnUpdateOprInvoicesDetail' + result.code1);
    //btnUpdate.attr("onclick", "UpdateOprInvoiceDetail(this);");
    //btnUpdate.val("Update");
    //cell.append(btnUpdate);

    //########################### hiden dev ######
    //var cell = $(row.insertCell(-1));

    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    //txtTotal2.attr('type', 'number');
    txtTotal2.attr('type', 'hidden');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'AVG_PRC_SAL' + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    txtTotal2.val(Stk_ItemUnit.AVG_PRC_SAL);
    cell.append(txtTotal2);

    //var cell = $(row.insertCell(-1));

    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    //txtTotal2.attr('type', 'number');
    txtTotal2.attr('type', 'hidden');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'searg' + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    txtTotal2.val(Stk_ItemUnit.searg);
    cell.append(txtTotal2);

    //var cell = $(row.insertCell(-1));

    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    //txtTotal2.attr('type', 'number');
    txtTotal2.attr('type', 'hidden');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'lst_prc_buy' + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    txtTotal2.val(Stk_ItemUnit.lst_prc_buy);
    cell.append(txtTotal2);
    //var cell = $(row.insertCell(-1));

    var txtTotal2 = $("<input />");
    txtTotal2.attr('style',  'width:100%; text-align:center;');
    txtTotal2.attr('class', 'form-control');
    //txtTotal2.attr('type', 'number');
    txtTotal2.attr('type', 'hidden');
    txtTotal2.attr('min', '1');
    txtTotal2.attr('id', 'beag' + TR_ID);
    txtTotal2.attr("onchange", "GrantTotalTable(false);");
    txtTotal2.val(Stk_ItemUnit.beag);
    cell.append(txtTotal2);

    //var cell = $(row.insertCell(-1));

    var txtItm_Ser = $("<input />");
    txtItm_Ser.attr('style', 'width:100%; text-align:center;');
    txtItm_Ser.attr('class', 'form-control');
    //txtItm_Ser.attr('type', 'number');
    txtItm_Ser.attr('type', 'hidden');
    txtItm_Ser.attr('min', '1');
    txtItm_Ser.attr('id', 'Itm_Ser' + TR_ID);
    //txtItm_Ser.attr("onchange", "GrantTotalTable(false);");
    txtItm_Ser.val(Stk_ItemUnit.ITM_SER);
    cell.append(txtItm_Ser);
    //var cell = $(row.insertCell(-1));

    var txtaddkta = $("<input />");
    txtaddkta.attr('style', 'width:100%; text-align:center;');
    txtaddkta.attr('class', 'form-control');
    //txtaddkta.attr('type', 'number');
    txtaddkta.attr('type', 'hidden');
    txtaddkta.attr('min', '1');
    txtaddkta.attr('id', 'addkta' + TR_ID);
    txtaddkta.attr("onchange", "GrantTotalTable(false);");
    txtaddkta.val(Stk_ItemUnit.addkta);
    cell.append(txtaddkta);
    //var cell = $(row.insertCell(-1));

    var txtctg_ser = $("<input />");
    txtctg_ser.attr('style', 'width:100%; text-align:center;');
    txtctg_ser.attr('class', 'form-control');
    //txtctg_ser.attr('type', 'number');
    txtctg_ser.attr('type', 'hidden');
    txtctg_ser.attr('min', '1');
    txtctg_ser.attr('id', 'ctg_ser' + TR_ID);
    //txtctg_ser.attr("onchange", "GrantTotalTable(false);");
    txtctg_ser.val(Stk_ItemUnit.ctg_ser);
    cell.append(txtctg_ser);
    //var cell = $(row.insertCell(-1));

    var txtNOTS_ITEMS = $("<input />");
    txtNOTS_ITEMS.attr('style', 'width:100%; text-align:center;');
    txtNOTS_ITEMS.attr('class', 'form-control');
    //txtNOTS_ITEMS.attr('type', 'number');
    txtNOTS_ITEMS.attr('type', 'hidden');
    txtNOTS_ITEMS.attr('min', '1');
    txtNOTS_ITEMS.attr('id', 'NOTS_ITEMS' + TR_ID);
    //txtNOTS_ITEMS.attr("onchange", "GrantTotalTable(false);");
    //txtNOTS_ITEMS.val(Stk_ItemUnit.beag);
    cell.append(txtNOTS_ITEMS);

    //########################### hiden dev ######

    var cell = $(row.insertCell(-1));

    var btnRemove = $("<input />");
    btnRemove.attr("type", "button");
    btnRemove.attr('class', 'btn btn-danger btn-xs');
    btnRemove.attr("onclick", "Remove(this);");
    btnRemove.val(" X ");
    cell.append(btnRemove);
  
    ClearInvoiceItemTableRowData();

    GrantTotalTable(false)
        .then((result) => {
            GrantTotalTable(false);
        });
         
       
    
}


var ClearInvoiceItemTableRowData = function () {
 
    $('#ItemId').val(0).trigger('change');
      
}

function Remove(button) {
    Swal.fire({
        title: 'Do you want to delete this item?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes'
    }).then((result) => {
        if (result.value) {
            var row = $(button).closest("TR");
            var table = $("#tblOprInvoiceDetail")[0];
             //############ my #####
            var table1 = document.getElementById("tblOprInvoiceDetail");
            var rows1 = table1.getElementsByTagName("tr");
            //var TR_ID = rows1.length - 2;
            var TR_ID_delete = -1;
            for (var TR_ID = 1; TR_ID < rows1.length; TR_ID++) {
                if (TR_ID === row[0].rowIndex) {
                    TR_ID_delete = row[0].rowIndex;
                    table.deleteRow(row[0].rowIndex);
                }
                // alert(row[0].rowIndex);
              //   alert(TR_ID);
            }

             var table2 = $("#tblOprInvoiceDetail");
            //############ my ##########
            
            let allow_uppdat_id = false;
            // كرر على جميع الصفوف باستثناء العنوان
            table2.find("tr:gt(0)").each(function (index) {
                
                var TR_ID = index + 1;
                //alert(TR_ID_delete);
                //var firstCell = $(this).find("#ID1");

                //// استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                //firstCell.attr("id", "new_id_" + (index + 1));
                    //ID Code1 ItemName  Quantity Unit UnitPrice  ItemDiscount Total ItemVAT Total_vat Total2 code2 AVG_PRC_SAL searg lst_prc_buy beag
                if (TR_ID === TR_ID_delete) {
                    allow_uppdat_id = true;
                }
                if (allow_uppdat_id) {
                    var TR_ID_old = TR_ID + 1;
                    // احصل على الخلية الأولى في كل صف باستخدام id ""
                    //###################
                    var Cell = $(this).find("#ID" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "ID" + (TR_ID));
                     $("#ID" + TR_ID).val(TR_ID);
                    //################
                     //###################
                    var Cell = $(this).find("#Code1" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "Code1" + TR_ID);
                    //$("#Code1" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#ItemName" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "ItemName" + TR_ID);
                    //$("#ItemName" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#Quantity" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "Quantity" + TR_ID);
                    //$("#Quantity" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#Unit" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "Unit" + TR_ID);
                    //$("#Unit" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#UnitPrice" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "UnitPrice" + TR_ID);
                    //$("#UnitPrice" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#ItemDiscount" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "ItemDiscount" + TR_ID);
                    //$("#ItemDiscount" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#Total" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "Total" + TR_ID);
                    //$("#Total" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#ItemVAT" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "ItemVAT" + TR_ID);
                    //$("#ItemVAT" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#Total_vat" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "Total_vat" + TR_ID);
                    //$("#Total_vat" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#Total2" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "Total2" + TR_ID);
                    //$("#Total2" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#code2" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "code2" + TR_ID);
                    //$("#code2" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#AVG_PRC_SAL" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "AVG_PRC_SAL" + TR_ID);
                    //$("#AVG_PRC_SAL" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#searg" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "searg" + TR_ID);
                    //$("#searg" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#lst_prc_buy" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "lst_prc_buy" + TR_ID);
                    //$("#lst_prc_buy" + TR_ID).val(TR_ID - 1);
                    //################
                     //###################
                    var Cell = $(this).find("#beag" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "beag" + TR_ID);
                    //$("#beag" + TR_ID).val(TR_ID - 1);
                    //################
                     
                        //###################
                    var Cell = $(this).find("#Itm_Ser" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "Itm_Ser" + TR_ID);
                    //$("#beag" + TR_ID).val(TR_ID - 1);
                    //################
                     
                        //###################
                    var Cell = $(this).find("#addkta" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "addkta" + TR_ID);
                    //$("#beag" + TR_ID).val(TR_ID - 1);
                    //################
                     
                        //###################
                    var Cell = $(this).find("#ctg_ser" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "ctg_ser" + TR_ID);
                    //$("#beag" + TR_ID).val(TR_ID - 1);
                    //################
                     
                        //###################
                    var Cell = $(this).find("#NOTS_ITEMS" + TR_ID_old);
                    // استبدل id الخلية الأولى بـ "new_id_" + رقم الصف
                    Cell.attr("id", "NOTS_ITEMS" + TR_ID);
                    //$("#beag" + TR_ID).val(TR_ID - 1);
                    //################
                     

                }
            });
     

         //   var _OprInvoiceDetailId = $("TD", row).eq(0).html();
           
            toastr.success("OprInvoice details item has been deleted successfully. ID: " + result.Id, 'Success');
            GrantTotalTable(true);
        }
    });

 }
 
var UpdateSelected_Unite = function (button, code1, TR_ID) {
     if (code1 == null || code1 == '') return;
    var Unit_code_select = $('#Unit' + TR_ID).val();
    //alert(Unit_code_select);

    $.ajax({
        type: "GET",
        url: "/OprInvoice/GetItemByItemBarcode?ItemBarcode=" + code1,
        //data: OprInvoicesDetailItem,
        contentType: "application/json; charset=utf-8",

        dataType: "json",
        success: function (result) {
            if (result === null || result.SER === 0) {
                SwalSimpleAlert("Item not found for Barcode: ", "warning");

                Swal.fire({
                    title: "Item not found for Barcode: " + code1,
                    icon: 'info',
                    onAfterClose: () => {
                        setTimeout(function () {
                        
                            $("#OprInvoicesDetailsId1").val("");
                            $("#OprInvoicesDetailsId1").focus();
                        }, 0);
                    }
                });
                return;
            } else {
                var Stk_ItemUnit_select_unite;
                 $.each(result.listStk_ItemUnit, function (index, item) {
                     if (item.seq == Unit_code_select) {
                         Stk_ItemUnit_select_unite = item;
 
                         //alert(item.seq);
                     }
                  });
                //alert(parseFloat(Stk_ItemUnit_select_unite.BEAG));
 
                //    AddHTMLTableRow(result);
                $("#UnitPrice" + TR_ID).val(Stk_ItemUnit_select_unite.BEAG);
                $("#code2" + TR_ID).val(Stk_ItemUnit_select_unite.code2);
                $("#AVG_PRC_SAL" + TR_ID).val(Stk_ItemUnit_select_unite.AVG_PRC_SAL);
                $("#searg" + TR_ID).val(Stk_ItemUnit_select_unite.searg);
                $("#lst_prc_buy" + TR_ID).val(Stk_ItemUnit_select_unite.lst_prc_buy);
                $("#beag" + TR_ID).val(Stk_ItemUnit_select_unite.beag);
                $("#Itm_Ser" + TR_ID).val(Stk_ItemUnit_select_unite.ITM_SER);
                $("#addkta" + TR_ID).val(Stk_ItemUnit_select_unite.addkta);
                $("#ctg_ser" + TR_ID).val(Stk_ItemUnit_select_unite.ctg_ser);
                //$("#beag" + TR_ID).val(Stk_ItemUnit_select_unite.beag);
                $("#UnitPrice" + TR_ID).focus();
                //  $('#Quantity').focus();
                GrantTotalTable(false);

            }


        },
        error: function (errormessage) {
            SwalSimpleAlert(errormessage.responseText, "warning");
        }
    });
}

//######################### my Grant total #################

//let isZero_discount = true;
let tota_fatora_befor_zero = "0";
let txt_tklofa_fatora = "0";
//let Zkat_dTime = getCurrentDate();
//let Zkat_time = getCurrentTime();

let Selected_row_update = false;

async function GrantTotalTable(isZero_discount) {
    // استدعاء الدالة وحفظ القيمة المرجعة في متغير
    //################## my add  java scripppt ##########

    //ID Code1 ItemName  Quantity Unit UnitPrice  ItemDiscount Total ItemVAT Total_vat Total2

    var table1 = document.getElementById("tblOprInvoiceDetail");
    var rows1 = table1.getElementsByTagName("tr");
    //var TR_ID = rows1.length - 2;
        

        //################## my add  java scripppt ##########
    try {
        if (rows1.length != null) {
            if (rows1.length > 0) {
              
                //product_list_discounts = [];

                // Validity of disabling table editing
                
                $("#Total_invoice").val("0");
            
                tota_fatora_befor_zero = "0";
                 if (isZero_discount) {
                    $("#Opr_Discount_nsba").val("0");
                    $("#Opr_Discount").val("0");
                } else {
                    tota_fatora_befor_zero = $("#total_fatora").val();
                }
                $("#total_fatora").val("0");
                $("#total_fatora_2").val("0");
                $("#total_fatora_vat").val("0");
                txt_tklofa_fatora = "0";
              
                for (var TR_ID = 1; TR_ID < rows1.length; TR_ID++) {
                   
                    var ID_TR_ID = $('#ID' + TR_ID).val();
                    var Code1_TR_ID = $('#Code1' + TR_ID).val();
                    var ItemName_TR_ID = $('#ItemName' + TR_ID).val();
                    var Quantity_TR_ID = $('#Quantity' + TR_ID).val();
                    var Unit_TR_ID = $('#Unit' + TR_ID).val();
                    var UnitPrice_TR_ID = $('#UnitPrice' + TR_ID).val();
                    var ItemDiscount_TR_ID = $('#ItemDiscount' + TR_ID).val();
                    var Total_TR_ID = $('#Total' + TR_ID).val();
                    var ItemVAT_TR_ID = $('#ItemVAT' + TR_ID).val();
                    var Total_vat_TR_ID = $('#Total_vat' + TR_ID).val();
                    var Total2_TR_ID = $('#Total2' + TR_ID).val();
                    //####################

                     //for (let product_row of product_list) {
                    // Define appropriate variables here
                    var itemDiscount;
                    var itemTotal;
                    var itemQimaMdafa;
                    var itemTotalAfterKimaMdafa;

                
               
                    // Save the values in the appropriate variables
                    itemDiscount = incAmountDiscount(
                        TR_ID,
                        tota_fatora_befor_zero,
                        $("#Opr_Discount_nsba").val(),
                        $("#Opr_Discount").val(),
                        'discount'
                    );
                
                    itemTotal = incAmountDiscount(
                        TR_ID,
                        tota_fatora_befor_zero,
                        $("#Opr_Discount_nsba").val(),
                        $("#Opr_Discount").val(),
                        'item_total_row'
                    );
                   
                    itemQimaMdafa = incAmountDiscount(
                        TR_ID,
                        tota_fatora_befor_zero,
                        $("#Opr_Discount_nsba").val(),
                        $("#Opr_Discount").val(),
                        'item_qima_mdafa'
                    );
                     
                    itemTotalAfterKimaMdafa = incAmountDiscount(
                        TR_ID,
                        tota_fatora_befor_zero,
                        $("#Opr_Discount_nsba").val(),
                        $("#Opr_Discount").val(),
                        'total_after_kima_mdafa_row'
                    );

                    //############ my add javascript ########
                    $('#ItemDiscount' + TR_ID).val(itemDiscount);
                    $('#Total' + TR_ID).val(itemTotal);
                    $('#Total_vat' + TR_ID).val(itemQimaMdafa);
                    $('#Total2' + TR_ID).val(itemTotalAfterKimaMdafa);
                    //############# end add my javascript #########
                    let H_Txt_total_fatora = 0.0;
                    let H_Txt_total_fatora_2 = 0.0;
                    let H_Txt_total_thriba_fatora = 0.0;
                    let H_txt_tklofa_fatora = 0.0;
                    let H_Total_invoice = 0.0;

                    let H_G_kmiat = 0.0;
                    var G_Kiarat_model_rebh = $("#G_Kiarat_model_rebh").val();
                    var code_name = $("#code_name").val();
                  

                    //product_list_discounts.forEach(element => {
                    for (var TR_ID_sup = 1; TR_ID_sup < rows1.length -1; TR_ID_sup++) {
                        var ID_TR_ID_sup = $('#ID' + TR_ID_sup).val();
                        var Code1_TR_ID_sup = $('#Code1' + TR_ID_sup).val();
                        var ItemName_TR_ID_sup = $('#ItemName' + TR_ID_sup).val();
                        var Quantity_TR_ID_sup = $('#Quantity' + TR_ID_sup).val();
                        var Unit_TR_ID_sup = $('#Unit' + TR_ID_sup).val();
                        var UnitPrice_TR_ID_sup = $('#UnitPrice' + TR_ID_sup).val();
                        var ItemDiscount_TR_ID_sup = $('#ItemDiscount' + TR_ID_sup).val();
                        var Total_TR_ID_sup = $('#Total' + TR_ID_sup).val();
                        var ItemVAT_TR_ID_sup = $('#ItemVAT' + TR_ID_sup).val();
                        var Total_vat_TR_ID_sup = $('#Total_vat' + TR_ID_sup).val();
                        var Total2_TR_ID_sup = $('#Total2' + TR_ID_sup).val();
                        var AVG_PRC_SAL_TR_ID_sup = $('#AVG_PRC_SAL' + TR_ID_sup).val();
                        var searg_TR_ID_sup = $('#searg' + TR_ID_sup).val();
                        var lst_prc_buy_TR_ID_sup = $('#lst_prc_buy' + TR_ID_sup).val();
                        var beag_TR_ID_sup = $('#beag' + TR_ID_sup).val();
                         
                     
                        //######################
                        H_G_kmiat += parseFloat(Quantity_TR_ID_sup); // Total of the required quantities
                        H_Txt_total_fatora += parseFloat(Total_TR_ID_sup);
                        H_Txt_total_thriba_fatora += parseFloat(Total_vat_TR_ID_sup);
                     //   alert(H_Txt_total_fatora);
                        if (code_name === "invoice_customer") {
                             if (G_Kiarat_model_rebh === "0") {
                                // Calculate the profit of the order based on the average price
                                if (parseFloat(AVG_PRC_SAL_TR_ID_sup) > 0) {
                                    H_txt_tklofa_fatora += parseFloat(AVG_PRC_SAL_TR_ID_sup) * parseFloat(Quantity_TR_ID_sup );
                                } else {
                                    H_txt_tklofa_fatora += parseFloat(searg_TR_ID_sup) * parseFloat(Quantity_TR_ID_sup );
                                }
                            } else if (G_Kiarat_model_rebh === "1") {
                                // Calculate the profit of the order based on the latest input price
                                if (parseFloat(lst_prc_buy_TR_ID_sup) > 0) {
                                    H_txt_tklofa_fatora += parseFloat(lst_prc_buy_TR_ID_sup) * parseFloat(Quantity_TR_ID_sup );
                                } else if (parseFloat(AVG_PRC_SAL_TR_ID_sup) >= 0) {
                                    H_txt_tklofa_fatora += parseFloat(AVG_PRC_SAL_TR_ID_sup) * parseFloat(Quantity_TR_ID_sup );
                                } else {
                                    H_txt_tklofa_fatora += parseFloat(searg_TR_ID_sup) * parseFloat(Quantity_TR_ID_sup );
                                }
                            } else if (G_Kiarat_model_rebh == "2") {
                                 
                                // Calculate the profit of the order based on the cost
                                 H_txt_tklofa_fatora += parseFloat(searg_TR_ID_sup) * parseFloat(Quantity_TR_ID_sup);
                            }
                        } else if (code_name === "invoice_suppler") {
                            // Calculate the total at the selling price in the purchases
                            H_txt_tklofa_fatora += parseFloat(beag_TR_ID_sup) * parseFloat(Quantity_TR_ID_sup );
                        }
                    };
                    $("#G_kmiat").val(H_G_kmiat.toFixed(2));

                    H_Txt_total_fatora_2 =
                        H_Txt_total_fatora - parseFloat($("#Opr_Discount").val());

                    $("#total_fatora").val(H_Txt_total_fatora.toFixed(2));
                    $("#total_fatora_2").val(H_Txt_total_fatora_2.toFixed(2));
                    $("#total_fatora_vat").val(H_Txt_total_thriba_fatora.toFixed(2));
                    txt_tklofa_fatora = H_txt_tklofa_fatora.toFixed(2);//تكلفة الفاتورة
                    $("#Opr_total_tklfa").val(txt_tklofa_fatora);
                    $("#Invoice_rebh").val((H_Txt_total_fatora_2 - H_txt_tklofa_fatora).toFixed(3));
                    $("#Total_invoice").val(  (
                        H_Txt_total_fatora_2 + H_Txt_total_thriba_fatora
                    ).toFixed(2));
                    $("#Total_invoice").val(truncateDecimal(parseFloat($("#Total_invoice").val())));
                   // alert(txt_tklofa_fatora);
                    //if (isZero_discount) {
                    //    date_fatora = getCurrentDate();
                    //    fatora_time = getCurrentTime();
                    //} else {
                    //    date_fatora = Zkat_dTime;
                    //    fatora_time = Zkat_time;
                    //}
                }
                UpdateQr_new(parseFloat($("#Total_invoice").val()), parseFloat($("#total_fatora_vat").val()));

            } else {
                if (!Selected_row_update) {
                    $("#total_fatora").val("0");
                    $("#total_fatora_2").val("0")
                    $("#total_fatora_vat").val("0");
                    txt_tklofa_fatora = "0";
                    $("#Opr_Discount_nsba").val("0");
                    $("#Opr_Discount").val("0");
                    $("#Total_invoice").val("0");
                }
            }
        } else {
            if (!Selected_row_update) {
                $("#total_fatora").val("0");
                $("#total_fatora_2").val("0")
                $("#total_fatora_vat").val("0");
                txt_tklofa_fatora = "0";
                $("#Opr_Discount_nsba").val("0");
                $("#Opr_Discount").val("0");
                $("#Total_invoice").val("0");
             }
        }
    } catch (e) {
        $("#total_fatora").val("0");
        $("#total_fatora_2").val("0");
        $("#total_fatora_vat").val("0");
          txt_tklofa_fatora = "0";
        $("#Opr_Discount_nsba").val("0");
        $("#Opr_Discount").val("0");
        $("#Total_invoice").val("0");
    }
    return true;
}

 
 
 
function incAmountDiscount(product_row, totalFatoraBefore, discNsba, discVal, type) {
 
     let amt = 0.0;
    let discount = 0.0;
    let discountRow = 0.0;
    let totalFatora = 0.00;
    let totalThriba = 0.00;
    let itemTotalRow = 0.00;
    let itemTaxRow = 0.00;
    let qty = $('#Quantity' + product_row).val() ? parseFloat($('#Quantity' + product_row).val()) : 0;
    let price = $('#UnitPrice' + product_row).val() ? parseFloat($('#UnitPrice' + product_row).val()) : 0;
    itemTaxRow = $('#ItemVAT' + product_row).val() ? parseFloat($('#ItemVAT' + product_row).val()) : 0;
    itemTotalRow = qty * price;
     if (totalFatoraBefore) {
        totalFatora = parseFloat(totalFatoraBefore);
    }

    if (discVal) {
        discount = parseFloat(discVal);
        if (totalFatora !== 0.00) {
            discountRow = (itemTotalRow / (totalFatora * 1)) * discount;
        }
    }

    if (type === "discount") {
        amt = discountRow;
    } else if (type === "item_qima_mdafa") {
        var Type_invoice_vat = document.getElementById("Opr_Enable_Vat");
        //alert(Type_invoice_vat.checked);
        amt = ((itemTotalRow - discountRow) * (itemTaxRow / 100)) *
            (Type_invoice_vat.checked === true ? 1 : 0);
    } else if (type === "total_after_kima_mdafa_row") {
        amt = itemTotalRow + ((itemTotalRow - discountRow) * (itemTaxRow / 100));
        amt = truncateDecimal(amt); // Truncate the decimal to 0, 1, 2, or 3 places
    } else if (type === "item_total_row") {
        amt = itemTotalRow;
    }
     return amt >= 0 ? translateNum(amt.toFixed(3)) : "0";
}
function truncateDecimal(number) {
    //if (G_Kiarat_model.dwra === "1") { // Activate the option to deduct fractions from net sales
        const wholeNumber = Math.trunc(number); // Whole number part before the decimal
        const decimalPart = number - wholeNumber; // Decimal part after the decimal

        const decimalDigits = decimalPart.toFixed(5).slice(2); // Digits after the decimal, up to 5 decimal places

        if (decimalDigits.length >= 2) {
            const secondDigit = parseInt(decimalDigits[1]);
            if (secondDigit === 0 || secondDigit === 1 || secondDigit === 2 || secondDigit === 3) {
                return parseFloat(`${wholeNumber}.${decimalDigits[0]}00`);
            }
        }
    //}
    return number;
}

function translateNum(num) {
    // Implement the translateNum function to convert the number to the desired format
    return num.replace(/٠/g, "0")
        .replace(/١/g, "1")
        .replace(/٢/g, "2")
        .replace(/٣/g, "3")
        .replace(/٤/g, "4")
        .replace(/٥/g, "5")
        .replace(/٦/g, "6")
        .replace(/٧/g, "7")
        .replace(/٨/g, "8")
        .replace(/٩/g, "9")
        .replace(/،/g, ".")
        .replace(/٫/g, ".");
}
//####################### end my grant total ###############

var UpdateQr_new = function (Total, Tax) {

    if (Total == null || Total == '') return;
 
    $.ajax({
        type: "GET",
        url: "/OprInvoice/GetQrNew?Total=" + Total + "&Tax=" + Tax,
        //data: OprInvoicesDetailItem,
        contentType: "application/json; charset=utf-8",

        dataType: "json",
        success: function (result) {
            if (result === null) {
              //  SwalSimpleAlert("Item not found for Barcode: ", "warning");

            
                return;
            } else {
                //document.getElementById('myImage').src = result;
                document.getElementById('Opr_Qr_invoice').src = 'data:image/png;base64,' + result ;

            //    $("#UnitPrice" + TR_ID).val(result);
            }


        },
        error: function (errormessage) {
            SwalSimpleAlert(errormessage.responseText, "warning");
        }
    });
}
