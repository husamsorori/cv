var Details = function (id) {
    var url = "/OprInvoice/Details?id=" + id;
    $('#titleExtraBigModal').html("OprInvoice Details");
    loadExtraBigModal(url);
};

var ViewCustomerDetails = function (id) {
    //var url = "/CustomerInfo/Details?id=" + id;
    var url = "/OprInvoice/AccDetails?id=" + id;
    $('#titleBigModal').html("Customer Info Details");
    loadBigModal(url);
};

var POSReport = function (id) {
    var url = "/OprInvoice/POSReport?id=" + id;
    $('#titleSmallModal').html("POS Report");
    loadCommonModal(url);
};
 
var PrintPOSReport = function (id) {
    //location.href = "/OprInvoice/PrintPOSReport?id=" + id;

    var url = "/OprInvoice/PrintPOSReport?id=" + Id;

    $.ajax({
        //url: "/OprInvoice/AddEditview?id=2", 
        url: url,
        type: 'GET',
        //   contentType: "application/json; charset=utf-8",
        //   dataType: "json",
        success: function (data) {
            //   SwalSimpleAlert(data, "warning");
            $('#divInvoiceOpr_print').html(data);
             $('#InvoiceOpr_print').tab('show');
            //   LoadTableRowFromDBFromModel();

            // LoadDataTables();
            // GetOprInvoiceSummaryData();
        },
        error: function (xhr, status, error) {
            console.log('Error: ' + error);
        }
    });
};

var PrintOprInvoiceInvoice = function (OprInvoiceId) {
    location.href = "/OprInvoice/PrintOprInvoiceInvoice?_OprInvoiceId=" + OprInvoiceId;
};

 

var AddEditModel = function (id, name) {
    var url = "/OprInvoice/AddEditModel?id=" + id;
    if (id > 0) {
        $('#titleExtraBigModal').html("Edit OprInvoice");
        //GetOprInvoiceSummary(id);
    } else {
        //$('#titleExtraBigModal').html("Add OprInvoice");
        $('#titleExtraBigModal').html(name);
    }
    localStorage.removeItem('OprInvoiceId');
    localStorage.removeItem('CurrentURL');
    loadExtraBigModal(url);
};

 

 
var loadInvoiceOpr_print = function (Id) {


    var url = "/OprInvoice/PrintOprInvoice?_OprInvoiceId=" + Id;

    $.ajax({
        //url: "/OprInvoice/AddEditview?id=2", 
        url: url,
        type: 'GET',
        //   contentType: "application/json; charset=utf-8",
        //   dataType: "json",
        success: function (data) {
            //   SwalSimpleAlert(data, "warning");
            $('#divInvoiceOpr_print').html(data);
            // ����� ����� ������� "OtherInfo"
            $('#InvoiceOpr_print').tab('show');
            //   LoadTableRowFromDBFromModel();

            // LoadDataTables();
            // GetOprInvoiceSummaryData();
        },
        error: function (xhr, status, error) {
            console.log('Error: ' + error);
        }
    });
}
    
var loadInvoiceOpr_LR = function (Typ) {
  //  alert(Typ);
    if (Typ === "L") {
        var IdNew = parseInt($("#Ser").val()) + 1;
        //   alert(IdNew);
        loadInvoiceOpr(IdNew);
    } else if (Typ === "R") {
        var IdNew = parseInt($("#Ser").val()) - 1;
        // alert(IdNew);

        loadInvoiceOpr(IdNew);
    } else {
        var IdNew = parseInt($("#Ser").val());
        // alert(IdNew);

        loadInvoiceOpr(IdNew);
    }
}
var loadInvoiceOpr = function (Id) {
 
    
    var url = "/OprInvoice/AddEdit?id=" + Id +"&OprType=view";
    //var url = "/OprInvoice/InvoiceOpr?id=" + Id;

    $.ajax({
        //url: "/OprInvoice/AddEditview?id=2", 
        url: url,
        type: 'GET',
        //   contentType: "application/json; charset=utf-8",
        //   dataType: "json",
        success: function (data) {
            //   SwalSimpleAlert(data, "warning");
            $('#divInvoiceOpr').html(data);
            // ����� ����� ������� "OtherInfo"
            $('#InvoiceOpr').tab('show');
         //   LoadTableRowFromDBFromModel();

           // LoadDataTables();
           // GetOprInvoiceSummaryData();
        },
        error: function (xhr, status, error) {
            console.log('Error: ' + error);
        }
    });
}

var loadReortTable = function () {
   // loadExtraBigModal("/OprInvoice/AddEditview?id=2");
   // SwalSimpleAlert("77", "warning");
    var _StartDate = $("#StartDate").val();
    var _EndDate = $("#EndDate").val();
  var  url = "/OprInvoice/Index?StartDate= " + _StartDate + "&EndDate= " + _EndDate;

    $.ajax({
        //url: "/OprInvoice/AddEditview?id=2", 
        url: url,
        type: 'GET',
     //   contentType: "application/json; charset=utf-8",
     //   dataType: "json",
        success: function (data) {
         //   SwalSimpleAlert(data, "warning");
            $('#divOtherInfo').html(data);
            // ����� ����� ������� "OtherInfo"
            $('#OtherInfo').tab('show');

            LoadDataTables();
         //   GetOprInvoiceSummaryData();
         },
        error: function (xhr, status, error) {
            console.log('Error: ' + error);
        }
    });
}


var OprInvoice = function (result, Opr_Type_button) {
    
    var _PreparedFormObj = PreparedFormObj(result, Opr_Type_button);
    $("#btnSave").val("Please Wait");
    $('#btnSave').attr('disabled', 'disabled');
    //alert(_PreparedFormObj.OprInvoiceTran.Ser);
     $.ajax({
        type: "POST",
        url: "/OprInvoice/AddEdit",
        data: _PreparedFormObj,
        dataType: "json",
        success: function (result) {
            if (result.IsSuccess) {
                Swal.fire({
                    title: result.AlertMessage,
                    icon: "success"
                }).then(function () {
                    document.getElementById("btnClose").click();
                    $("#btnSave").val("Save");
                    $('#btnSave').removeAttr('disabled');
                      //   $('#tblOprInvoices').DataTable().ajax.reload();
                    if (Opr_Type_button == "delete")
                        alert(1);
                        //loadInvoiceOpr(0);
                });
            }

            else {
                Swal.fire({
                    title: result.AlertMessage,
                    icon: "warning"
                }).then(function () {
                    $("#btnSave").val("Save");
                    $('#btnSave').removeAttr('disabled');
                    setTimeout(function () {
                        $('#ItemId').focus();
                    }, 400);
                });
            }
        },
        error: function (errormessage) {
            SwalSimpleAlert(errormessage.responseText, "warning");
        }
    });
}


var Delete = function (id) {
    Swal.fire({
        title: 'Do you want to delete this item?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes'
    }).then((result) => {
        if (result.value) {
            $.ajax({
                type: "DELETE",
                url: "/OprInvoice/Delete?id=" + id,
                success: function (result) {
                    var message;
                   // if (result.Category == 1) {
                        $('#tblOprInvoices').DataTable().ajax.reload();
                        message = "Invoice has been deleted successfully. Invoice ID: " + result;
                   // }
                   
                    Swal.fire({
                        title: message,
                        icon: 'info',
                        onAfterClose: () => {
                        }
                    });
                }
            });
        }
    });
};

var AddNewCustomer = function () {
    activaTab('divAddNewCustomer');
};

$(document).ready(function () {
    $('.CustomerId').select2({
        ajax: {
            type: "GET",
            url: '/CustomerInfo/GetAllCustomerForDDL',
            dataType: 'json'
        },
    });
});


var GetPriceModel = function () {
    var _PriceModel = $("#PriceModel").val();
    $.ajax({
        type: "GET",
        url: "/OprInvoice/GetPriceModel?Id=" + _PriceModel,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
            if (data === null) return;
            var $dropdown = $('#ItemId');
            $('#ItemId').html('').select2({ data: [{ id: '', text: '' }] });
            $.each(data, function () {
                $dropdown.append($("<option />").val(this.Id).text(this.Name));
            });
        },
        error: function (response) {
            SwalSimpleAlert(errormessage.responseText, "warning");
        }
    });

};


var GetItemByItemBarcode = function (_ItemBarcode) {
     if (_ItemBarcode === null || _ItemBarcode === '') return;

    $.ajax({
        type: "GET",
        url: "/OprInvoice/GetItemByItemBarcode?ItemBarcode=" + _ItemBarcode,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
            if (data === null) {
                SwalSimpleAlert("Item not found for Barcode: ", "warning");

                //Swal.fire({
                //    title: "Item not found for Barcode: " + _ItemBarcode,
                //    icon: 'info',
                //    onAfterClose: () => {
                //        setTimeout(function () {
                //            $('#ItemBarcode').focus();
                //        }, 300);
                //    }
                //});
                //   return;
            } else {
                SwalSimpleAlert(data.Name, "warning");
           //// SwalSimpleAlert(data.Id, "warning");
        //   $("#ItemId").(data.Name);
         //  $('#ItemId').append(data.Id).trigger('change');
         //  UpdateUnitPrice();
         //  $('#Quantity').focus();
            }
          
          },
        error: function (response) {
            SwalSimpleAlert(errormessage.responseText, "warning");
        }
    });

};

 
var GetCustomerHistory = function (CustomerId) {
    if(CustomerId > 0)
    $.ajax({
        type: "GET",
        url: "/OprInvoice/GetCustomerHistory?CustomerId=" + CustomerId,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
            if (data === null) {
                $("textarea#CustomerNote").val('');
                return;
            }
            $("textarea#CustomerNote").val(data.Notes);
            //$("#PrevousBalance").val(data.PrevousBalance.toFixed(2));
        },
        error: function (response) {
            SwalSimpleAlert(response.responseText, "warning");
        }
    });
};

var GetOprInvoiceSummary = function (Id) {
    $.ajax({
        type: "GET",
        url: "/OprInvoice/GetOprInvoiceSummary?Id=" + Id,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (result) {
           // UpdateOprInvoiceFields(result);
        },
        error: function (errormessage) {
            alert(errormessage.responseText);
        }
    });
}



var PreparedFormObj = function (result, Opr_Type_button) {

    result.Opr_Type_button = Opr_Type_button;
    result.OprInvoiceTran.Ser = $("#Ser").val();
    result.OprInvoiceTran.TranNo = $("#Ser").val();
    result.OprInvoiceTran.ydoy = $("#ydoy").val();
    result.OprInvoiceTran.tlb = $("#tlb").val();
    result.OprInvoiceTran.Cash = $("#Cash").val();
    result.OprInvoiceTran.TranDate = $("#TranDate").val();
    result.OprInvoiceTran.Vnd_Cust = $("#Vnd_Cust").val();
    result.OprInvoiceTran.ESTHKAK = $("#ESTHKAK").val();
    result.OprInvoiceTran.sheek = $("#sheek").val();
    result.OprInvoiceTran.OMLA = $("#OMLA").val();
    result.OprInvoiceTran.tadol = $("#tadol").val();
    result.OprInvoiceTran.fra = $("#fra").val();
    result.OprInvoiceTran.EmpTo = $("#EmpTo").val();
    result.OprInvoiceTran.Contact = $("#Contact").val();
    result.OprInvoiceTran.TKLFA = $("#TKLFA").val();
    result.OprInvoiceTran.HASEB = $("#HASEB").val();
    result.OprInvoiceTran.BYAN = $("#BYAN").val();
    result.total_fatora = $("#total_fatora").val();
    result.OprInvoiceTran.Discount = $("#Opr_Discount").val();
    result.Opr_Discount = $("#Opr_Discount").val();
    result.OprInvoiceTran.total_fatora_2 = $("#total_fatora_2").val();
    result.OprInvoiceTran.mgmamoad = $("#total_fatora_vat").val();
    result.total_fatora_vat = $("#total_fatora_vat").val();
    result.Total_invoice = $("#Total_invoice").val();
    result.Invoice_rebh = $("#Invoice_rebh").val();
    result.Opr_total_tklfa = $("#Opr_total_tklfa").val();
    result.Acc_rased = $("#Acc_rased").val();
    result.OprInvoiceTran.nmden = $("#Opr_mden").val();
    result.OprInvoiceTran.ndaen = $("#Opr_daen").val();
    result.Opr_msrofat = $("#Opr_msrofat").val();
    result.Vat_Bldia = $("#Vat_Bldia").val();
    result.Opr_msrofat = $("#Opr_msrofat").val();
    result.Opr_msrofat = $("#Opr_msrofat").val();
    result.Dfaa_mstlm = $("#Dfaa_mstlm").val();
    result.Dfaa_mtbqi = $("#Dfaa_mtbqi").val();
    result.Dfaa_nqd = $("#Dfaa_nqd").val();
    result.Dfaa_shbka = $("#Dfaa_shbka").val();
    result.OprInvoiceTran.MDFOA = $("#Dfaa_mstlm").val();
    result.OprInvoiceTran.buer = $("#Dfaa_shbka").val();
    result.code_name = $("#code_name").val();
    //alert(result.OprInvoiceTran.Ser);

 

    // Get the data from the table on the screen
    var table1 = document.getElementById("tblOprInvoiceDetail");
    var rows1 = table1.getElementsByTagName("tr");
    //var TR_ID = rows1.length - 2;
    const listOprInvoiceDT = [];
    //alert(rows1.length);
    for (var TR_ID = 1; TR_ID < rows1.length - 1; TR_ID++) {
        //alert("#ID" + TR_ID); 
           
        const OprInvoiceDT = {
            ID: $("#ID" + TR_ID).val(),
            Code1: $("#Code1" + TR_ID).val(),
            ItemName: $("#ItemName" + TR_ID).val(),
            Quantity: $("#Quantity" + TR_ID).val(),
            Unit: $("#Unit" + TR_ID).val(),
            UnitName: "",
            UnitPrice: $("#UnitPrice" + TR_ID).val(),
            ItemDiscount: $("#ItemDiscount" + TR_ID).val(),
            Total: $("#Total" + TR_ID).val(),
            ItemVAT: $("#ItemVAT" + TR_ID).val(),
            Total_vat: $("#Total_vat" + TR_ID).val(),
            Total2: $("#Total2" + TR_ID).val(),
            code2: $("#code2" + TR_ID).val(),
            AVG_PRC_SAL: $("#AVG_PRC_SAL" + TR_ID).val(),
            searg: $("#searg" + TR_ID).val(),
            lst_prc_buy: $("#lst_prc_buy" + TR_ID).val(),
            beag: $("#beag" + TR_ID).val(),
            Itm_Ser: $("#Itm_Ser" + TR_ID).val(),
            addkta: $("#addkta" + TR_ID).val(),
            ctg_ser: $("#ctg_ser" + TR_ID).val(),
            NOTS_ITEMS: $("#NOTS_ITEMS" + TR_ID).val()
        };
        listOprInvoiceDT.push(OprInvoiceDT);
    }
    result.listOprInvoiceDT = listOprInvoiceDT;
    return result;
}